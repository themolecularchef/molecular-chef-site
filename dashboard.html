<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Ki≈üisel tarif listenizi y√∂netin. Favorilerinizi kaydedin, √∂zel listeler olu≈üturun.">
    <title>Listelerim | Lezzet Yolculuƒüu</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/components.css">

    <link rel="icon" type="image/png" href="assets/images/Logo.png">

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCfWLSG4d7bamB-_3rDCeZFnM5Paq4GBO4",
            authDomain: "the-molecular-chef-17eb2.firebaseapp.com",
            projectId: "the-molecular-chef-17eb2",
            storageBucket: "the-molecular-chef-17eb2.firebasestorage.app",
            messagingSenderId: "23609596807",
            appId: "1:23609596807:web:18db592c11caeaade29122"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();
    </script>
</head>

<body>
    <nav class="nav" id="nav">
        <div class="nav-container">
            <a href="index.html" class="nav-logo">
                <img src="assets/images/Logo.png" alt="Lezzet Yolculuƒüu"
                    style="height: 40px; width: 40px; object-fit: cover; border-radius: 50%; border: 2px solid white;">
                <span class="nav-logo-text">Lezzet Yolculuƒüu</span>
            </a>

            <div class="nav-links">
                <a href="index.html" class="nav-link">Tarifler</a>
                <a href="dashboard.html" class="nav-link active">Listelerim</a>
            </div>

            <div class="nav-actions">
                <button class="theme-toggle" id="themeToggle" aria-label="Tema deƒüi≈ütir">
                    <span class="theme-toggle-light">‚òÄÔ∏è</span>
                    <span class="theme-toggle-dark">üåô</span>
                </button>
                <div class="nav-user" id="navUser">
                    <span class="nav-user-name" id="navUserName"></span>
                    <button class="nav-logout" id="navLogout" title="√áƒ±kƒ±≈ü yap">‚Üí</button>
                </div>
            </div>

            <button class="nav-mobile-toggle" id="navMobileToggle" aria-label="Men√ºy√º a√ß">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </div>
    </nav>

    <div class="mobile-menu" id="mobileMenu">
        <a href="index.html" class="mobile-link">Tarifler</a>
        <a href="dashboard.html" class="mobile-link active">Listelerim</a>
        <button class="mobile-logout" id="mobileLogout">√áƒ±kƒ±≈ü Yap</button>
    </div>

    <main class="main main-dashboard" style="padding-top: calc(var(--nav-height) + var(--space-2xl));">
        <div class="container">
            <div class="dashboard-header" style="margin-bottom: var(--space-2xl);">
                <h1 class="dashboard-title"
                    style="font-family: var(--font-heading); font-size: clamp(1.75rem, 4vw, 2.5rem); font-weight: 600; margin-bottom: var(--space-sm);">
                    Merhaba, <span id="userName">Misafir</span> üëã
                </h1>
                <p class="dashboard-subtitle" style="font-size: 1rem; color: var(--color-text-secondary);">
                    Favori tariflerinizi ve listelerinizi g√∂r√ºnt√ºleyin
                </p>
            </div>

            <div style="margin-bottom: var(--space-xl);">
                <button id="createListBtn" class="btn btn-primary"
                    style="display: flex; align-items: center; gap: var(--space-sm);">
                    <span>+</span> Yeni Liste Olu≈ütur
                </button>
            </div>

            <!-- Create List Modal -->
            <div class="modal" id="createListModal">
                <div class="modal-backdrop"></div>
                <div class="modal-content modal-sm">
                    <button class="modal-close" onclick="Modal.close('createListModal')">√ó</button>
                    <div class="modal-header">
                        <h3 class="modal-title">Yeni Liste Olu≈ütur</h3>
                    </div>
                    <div class="modal-body">
                        <form id="createListForm">
                            <div class="form-group">
                                <label class="form-label" for="listName">Liste Adƒ±</label>
                                <input type="text" class="form-input" id="listName" placeholder="√ñrn: Hafta Sonu Men√ºs√º"
                                    required>
                            </div>
                            <button type="submit" class="btn btn-primary btn-full">Olu≈ütur</button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- List Detail Modal -->
            <div class="modal" id="listDetailModal">
                <div class="modal-backdrop"></div>
                <div class="modal-content modal-lg">
                    <button class="modal-close" onclick="Modal.close('listDetailModal')">√ó</button>
                    <div class="modal-header">
                        <h3 class="modal-title" id="listDetailTitle">Liste Adƒ±</h3>
                        <p class="modal-subtitle" id="listDetailCount">0 tarif</p>
                    </div>
                    <div class="modal-body">
                        <div id="listRecipesGrid"
                            style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: var(--space-lg);">
                        </div>
                        <div id="emptyListDetail" style="text-align: center; padding: var(--space-3xl); display: none;">
                            <div style="font-size: 4rem; margin-bottom: var(--space-lg); opacity: 0.5;">üìã</div>
                            <h4 style="font-family: var(--font-heading); font-size: 1.25rem; margin-bottom: var(--space-sm);">
                                Liste bo≈ü</h4>
                            <p style="color: var(--color-text-secondary); margin-bottom: var(--space-lg);">
                                Bu listeye hen√ºz tarif eklenmemi≈ü.</p>
                            <a href="index.html" class="btn btn-primary btn-sm">Tariflere G√∂z At</a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Lists Section -->
            <div class="lists-section">
                <div class="lists-header"
                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-xl);">
                    <h2 class="section-title"
                        style="font-family: var(--font-heading); font-size: 1.5rem; font-weight: 600;">Listelerim</h2>
                </div>

                <div class="lists-grid" id="listsGrid"
                    style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: var(--space-lg);">
                </div>

                <div id="emptyLists" style="text-align: center; padding: var(--space-3xl); display: none;">
                    <div style="font-size: 4rem; margin-bottom: var(--space-lg); opacity: 0.5;">üìã</div>
                    <h4 style="font-family: var(--font-heading); font-size: 1.5rem; margin-bottom: var(--space-sm);">
                        Hen√ºz listeniz yok</h4>
                    <p style="color: var(--color-text-secondary); margin-bottom: var(--space-lg);">
                        ƒ∞lk listenizi olu≈üturmak i√ßin "Yeni Liste" butonuna tƒ±klayƒ±n.</p>
                </div>
            </div>

            <!-- Favorites Section -->
            <div class="lists-section" style="margin-top: var(--space-3xl);">
                <div class="lists-header"
                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-xl);">
                    <h2 class="section-title"
                        style="font-family: var(--font-heading); font-size: 1.5rem; font-weight: 600;">Favorilerim</h2>
                </div>

                <div class="lists-grid" id="favoritesGrid"
                    style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: var(--space-lg);">
                </div>

                <div id="emptyFavorites" style="text-align: center; padding: var(--space-3xl); display: none;">
                    <div style="font-size: 4rem; margin-bottom: var(--space-lg); opacity: 0.5;">‚ù§Ô∏è</div>
                    <h4 style="font-family: var(--font-heading); font-size: 1.5rem; margin-bottom: var(--space-sm);">
                        Hen√ºz favori yok</h4>
                    <p style="color: var(--color-text-secondary); margin-bottom: var(--space-lg);">
                        Beƒüendiƒüiniz tarifleri favorilere ekleyin.</p>
                    <a href="index.html" class="btn btn-primary btn-sm">Tariflere G√∂z At</a>
                </div>
            </div>
        </div>
    </main>

    <div class="toast" id="toast">
        <span class="toast-message" id="toastMessage"></span>
    </div>

    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-brand">
                    <span class="footer-logo">
                        <img src="assets/images/Logo.png" style="height: 24px; width: auto; vertical-align: middle; margin-right: 8px;">
                        Lezzet Yolculuƒüu
                    </span>
                    <p class="footer-tagline">Evde profesyonel lezzetler</p>
                </div>
                <div class="footer-links">
                    <a href="index.html">Tarifler</a>
                    <a href="dashboard.html">Listelerim</a>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 Lezzet Yolculuƒüu. T√ºm haklarƒ± saklƒ±dƒ±r.</p>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="js/app.js"></script>
    <script src="js/recipes.js"></script>

    <script>
        let allRecipes = [];

        // Auth State
        firebase.auth().onAuthStateChanged(async (user) => {
            if (!user) {
                window.location.href = 'index.html';
                return;
            }

            document.getElementById('userName').textContent = user.displayName || user.email;
            document.getElementById('navUserName').textContent = user.displayName || user.email;

            await loadAllRecipes();
            await loadLists();
            await loadFavorites();
        });

        async function loadAllRecipes() {
            try {
                const response = await fetch('content/recipes.json');
                if (!response.ok) throw new Error('Tarifler y√ºklenemedi');
                const data = await response.json();
                allRecipes = data.recipes || [];
                window.recipesData = allRecipes;
            } catch (error) {
                console.error("Tarifler y√ºklenemedi:", error);
                allRecipes = [];
                window.recipesData = [];
                Toast.show('Tarifler y√ºklenirken hata olu≈ütu', 'error');
            }
        }

        async function loadLists() {
            const user = firebase.auth().currentUser;
            if (!user) return;

            try {
                const doc = await db.collection('users').doc(user.uid).get();
                const lists = doc.exists ? (doc.data().lists || []) : [];

                const grid = document.getElementById('listsGrid');
                const emptyState = document.getElementById('emptyLists');

                if (lists.length === 0) {
                    grid.innerHTML = '';
                    emptyState.style.display = 'block';
                    return;
                }

                emptyState.style.display = 'none';

                grid.innerHTML = lists.map(list => {
                    const recipeCount = list.recipes ? list.recipes.length : 0;
                    const recipeText = recipeCount === 0 ? 'Hen√ºz tarif yok' :
                        recipeCount === 1 ? '1 tarif' : `${recipeCount} tarif`;

                    let coverImage = '';
                    if (list.recipes && list.recipes.length > 0 && allRecipes.length > 0) {
                        const firstRecipe = allRecipes.find(r => r.id.toString() === list.recipes[0].toString());
                        if (firstRecipe) {
                            coverImage = `<img src="${firstRecipe.image}" alt="${list.name}" style="width: 100%; height: 100%; object-fit: cover;">`;
                        }
                    }

                    return `
                        <div class="list-card" style="background: var(--color-surface); border-radius: var(--radius-xl); overflow: hidden; box-shadow: var(--shadow-sm); cursor: pointer; transition: transform 0.2s;" 
                             onmouseover="this.style.transform='translateY(-4px)'" 
                             onmouseout="this.style.transform='translateY(0)'"
                             onclick="openListDetail('${list.id}')">
                            <div class="list-card-image" style="aspect-ratio: 16/10; background: var(--color-bg-secondary); display: flex; align-items: center; justify-content: center; font-size: 3rem; overflow: hidden;">
                                ${coverImage || 'üìã'}
                            </div>
                            <div class="list-card-content" style="padding: var(--space-lg);">
                                <h3 style="font-family: var(--font-heading); font-size: 1.125rem; font-weight: 600; margin-bottom: var(--space-xs);">${list.name}</h3>
                                <p style="font-size: 0.875rem; color: var(--color-text-secondary);">${recipeText}</p>
                                <div style="display: flex; gap: var(--space-sm); margin-top: var(--space-md);">
                                    <button onclick="event.stopPropagation(); openListDetail('${list.id}')" class="btn btn-primary btn-sm" style="flex: 1;">G√∂r√ºnt√ºle</button>
                                    <button onclick="event.stopPropagation(); deleteList('${list.id}')" class="btn btn-ghost btn-sm" style="color: var(--color-error);">Sil</button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error("Listeler y√ºklenemedi:", error);
                Toast.show('Listeler y√ºklenemedi', 'error');
            }
        }

        async function openListDetail(listId) {
            const user = firebase.auth().currentUser;
            if (!user) return;

            try {
                const doc = await db.collection('users').doc(user.uid).get();
                if (!doc.exists) return;

                const lists = doc.data().lists || [];
                const list = lists.find(l => l.id === listId);

                if (!list) return;

                document.getElementById('listDetailTitle').textContent = list.name;

                const recipeCount = list.recipes ? list.recipes.length : 0;
                document.getElementById('listDetailCount').textContent =
                    recipeCount === 0 ? 'Hen√ºz tarif yok' :
                        recipeCount === 1 ? '1 tarif' : `${recipeCount} tarif`;

                const grid = document.getElementById('listRecipesGrid');
                const emptyState = document.getElementById('emptyListDetail');

                if (recipeCount === 0) {
                    grid.style.display = 'none';
                    emptyState.style.display = 'block';
                } else {
                    grid.style.display = 'grid';
                    emptyState.style.display = 'none';

                    grid.innerHTML = list.recipes.map(recipeId => {
                        const recipe = allRecipes.find(r => r.id.toString() === recipeId.toString());
                        if (!recipe) return '';

                        return `
                            <div class="recipe-card" style="background: var(--color-surface); border-radius: var(--radius-lg); overflow: hidden; box-shadow: var(--shadow-sm);">
                                <div style="position: relative; aspect-ratio: 4/3; overflow: hidden;">
                                    <img src="${recipe.image}" alt="${recipe.title}" style="width: 100%; height: 100%; object-fit: cover;">
                                    <button onclick="removeFromList('${listId}', '${recipeId}')" 
                                            style="position: absolute; top: var(--space-sm); right: var(--space-sm); 
                                                   width: 32px; height: 32px; border-radius: 50%; 
                                                   background: rgba(255,255,255,0.95); border: none; 
                                                   cursor: pointer; font-size: 1rem; color: var(--color-error);">
                                        √ó
                                    </button>
                                </div>
                                <div style="padding: var(--space-md);">
                                    <span style="font-size: 0.6875rem; font-weight: 600; text-transform: uppercase; color: var(--color-accent);">${recipe.category}</span>
                                    <h4 style="font-family: var(--font-heading); font-size: 1rem; margin-top: var(--space-xs);">
                                        <a href="recipe.html?id=${recipe.id}" style="color: inherit;">${recipe.title}</a>
                                    </h4>
                                </div>
                            </div>
                        `;
                    }).join('');
                }

                Modal.open('listDetailModal');

            } catch (error) {
                console.error("Liste detayƒ± y√ºklenemedi:", error);
                Toast.show('Liste detayƒ± y√ºklenemedi', 'error');
            }
        }

        async function removeFromList(listId, recipeId) {
            const user = firebase.auth().currentUser;
            if (!user) return;

            try {
                const userRef = db.collection('users').doc(user.uid);
                const doc = await userRef.get();

                if (doc.exists) {
                    const lists = doc.data().lists || [];
                    const listIndex = lists.findIndex(l => l.id === listId);

                    if (listIndex !== -1) {
                        lists[listIndex].recipes = lists[listIndex].recipes.filter(id => id !== recipeId);
                        await userRef.update({ lists: lists });

                        Toast.show('Listeden √ßƒ±karƒ±ldƒ±');
                        openListDetail(listId);
                        loadLists();
                    }
                }
            } catch (error) {
                console.error("Tarif listeden √ßƒ±karƒ±lamadƒ±:", error);
                Toast.show('ƒ∞≈ülem yapƒ±lamadƒ±', 'error');
            }
        }

        // Create List
        document.getElementById('createListBtn')?.addEventListener('click', () => {
            Modal.open('createListModal');
        });

        document.getElementById('createListForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();

            const user = firebase.auth().currentUser;
            if (!user) {
                Toast.show('Giri≈ü yapmalƒ±sƒ±nƒ±z', 'error');
                return;
            }

            const listName = document.getElementById('listName').value.trim();
            if (!listName) return;

            try {
                const userRef = db.collection('users').doc(user.uid);
                const doc = await userRef.get();

                const newList = {
                    id: Date.now().toString(),
                    name: listName,
                    recipes: [],
                    createdAt: new Date().toISOString()
                };

                if (doc.exists) {
                    const currentLists = doc.data().lists || [];
                    await userRef.update({
                        lists: [...currentLists, newList]
                    });
                } else {
                    await userRef.set({
                        lists: [newList]
                    });
                }

                Toast.show('Liste olu≈üturuldu!', 'success');
                Modal.close('createListModal');
                document.getElementById('createListForm').reset();
                await loadLists();

            } catch (error) {
                console.error("Liste olu≈üturulamadƒ±:", error);
                Toast.show('Liste olu≈üturulamadƒ±', 'error');
            }
        });

        async function deleteList(listId) {
            if (!confirm('Bu listeyi silmek istediƒüinize emin misiniz?')) return;

            const user = firebase.auth().currentUser;
            if (!user) return;

            try {
                const userRef = db.collection('users').doc(user.uid);
                const doc = await userRef.get();

                if (doc.exists) {
                    const currentLists = doc.data().lists || [];
                    const updatedLists = currentLists.filter(l => l.id !== listId);
                    await userRef.update({ lists: updatedLists });

                    Toast.show('Liste silindi');
                    await loadLists();
                }
            } catch (error) {
                console.error("Liste silinemedi:", error);
                Toast.show('Liste silinemedi', 'error');
            }
        }

        async function loadFavorites() {
            const user = firebase.auth().currentUser;
            if (!user) return;

            try {
                const doc = await db.collection('users').doc(user.uid).get();
                if (!doc.exists) return;

                const favorites = doc.data().favorites || [];
                const grid = document.getElementById('favoritesGrid');

                if (favorites.length === 0) {
                    document.getElementById('emptyFavorites').style.display = 'block';
                    grid.innerHTML = '';
                    return;
                }

                document.getElementById('emptyFavorites').style.display = 'none';

                const favRecipes = allRecipes.filter(r => {
                    const recipeId = r.id.toString();
                    return favorites.some(fav => fav.toString() === recipeId);
                });

                grid.innerHTML = favRecipes.map(recipe => `
                    <div class="list-card">
                        <div style="aspect-ratio: 16/10; overflow: hidden; border-radius: var(--radius-xl) var(--radius-xl) 0 0;">
                            <img src="${recipe.image}" alt="${recipe.title}" style="width: 100%; height: 100%; object-fit: cover;">
                        </div>
                        <div style="padding: var(--space-lg);">
                            <h3 style="font-family: var(--font-heading); font-size: 1.125rem; margin-bottom: var(--space-sm);">
                                <a href="recipe.html?id=${recipe.id}">${recipe.title}</a>
                            </h3>
                            <button onclick="removeFavorite('${recipe.id}')" class="btn btn-ghost btn-sm" style="color: var(--color-error); width: 100%;">
                                Favorilerden √áƒ±kar
                            </button>
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                console.error("Favoriler y√ºklenemedi:", error);
                Toast.show('Favoriler y√ºklenemedi', 'error');
            }
        }

        async function removeFavorite(recipeId) {
            const user = firebase.auth().currentUser;
            if (!user) return;

            try {
                await db.collection('users').doc(user.uid).update({
                    favorites: firebase.firestore.FieldValue.arrayRemove(recipeId)
                });

                Toast.show('Favorilerden √ßƒ±karƒ±ldƒ±');
                loadFavorites();
            } catch (error) {
                console.error("Favori silinemedi:", error);
                Toast.show('Favori silinemedi', 'error');
            }
        }

        // Logout
        document.getElementById('navLogout')?.addEventListener('click', async () => {
            await firebase.auth().signOut();
            window.location.href = 'index.html';
        });

        document.getElementById('mobileLogout')?.addEventListener('click', async () => {
            await firebase.auth().signOut();
            window.location.href = 'index.html';
        });
    </script>
</body>
</html>
