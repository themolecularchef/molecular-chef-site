/**
 * Lezzet Yolculuƒüu - Recipes Module
 */

const Recipes = {
    data: null,
    currentRecipe: null,
    servingsMultiplier: 1,
    originalServings: 4,
    originalIngredients: [],

    init() {
        this.loadRecipes().then(() => {
            this.renderRecipesGrid();
            this.bindFilterEvents();
        });

        if (document.querySelector('.recipe-hero')) {
            this.loadRecipeDetail();
        }
    },

    async loadRecipes() {
        try {
            const response = await fetch('content/recipes.json');
            const data = await response.json();
            this.data = data.recipes || [];
            window.recipesData = this.data;
            return this.data;
        } catch (error) {
            console.error('Tarifler y√ºklenemedi:', error);
            this.data = [];
            window.recipesData = [];
        }
    },

    async loadRecipeContent(contentFile) {
        try {
            const response = await fetch(contentFile);
            const markdown = await response.text();
            return marked.parse(markdown);
        } catch (error) {
            return '<p>Tarif i√ßeriƒüi y√ºklenemedi.</p>';
        }
    },

    getRecipeById(id) {
        return this.data ? this.data.find(r => r.id.toString() === id.toString()) : null;
    },

    async renderRecipesGrid(recipes = null) {
        const grid = document.getElementById('recipesGrid');
        const emptyState = document.getElementById('emptyState');
        
        if (!grid) return;
        
        const recipesToRender = recipes || this.data;
        
        if (!recipesToRender || recipesToRender.length === 0) {
            grid.innerHTML = '';
            if (emptyState) emptyState.classList.remove('hidden');
            return;
        }
        
        if (emptyState) emptyState.classList.add('hidden');
        
        grid.innerHTML = recipesToRender.map(recipe => `
            <article class="recipe-card" data-id="${recipe.id}">
                <div class="recipe-card-image">
                    <img src="${recipe.image}" alt="${recipe.title}" loading="lazy">
                    <div class="recipe-card-overlay"></div>
                    <div class="recipe-card-actions">
                        <button class="recipe-card-action favorite-btn" 
                                data-id="${recipe.id}" 
                                data-title="${recipe.title}"
                                onclick="openAddToListModal('${recipe.id}', '${recipe.title}')">
                            <span>ü§ç</span>
                        </button>
                        <button class="recipe-card-action quick-view-btn" 
                                data-id="${recipe.id}">
                            <span>üëÅÔ∏è</span>
                        </button>
                    </div>
                </div>
                <div class="recipe-card-content">
                    <span class="recipe-card-category">${recipe.category}</span>
                    <h3 class="recipe-card-title">
                        <a href="recipe.html?id=${recipe.id}">${recipe.title}</a>
                    </h3>
                    <div class="recipe-card-meta">
                        <span>‚è±Ô∏è ${recipe.prepTime}</span>
                        <span>üî• ${recipe.cookTime}</span>
                        <span>üìä ${recipe.difficulty}</span>
                    </div>
                </div>
            </article>
        `).join('');
        
        this.bindCardEvents();
    },

    bindCardEvents() {
        document.querySelectorAll('.quick-view-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                this.showQuickView(btn.dataset.id);
            });
        });
    },

    bindFilterEvents() {
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                const filter = btn.dataset.filter;
                if (filter === 'all') {
                    this.renderRecipesGrid(this.data);
                } else {
                    const filtered = this.data.filter(r => r.category === filter);
                    this.renderRecipesGrid(filtered);
                }
            });
        });
    },

    async showQuickView(recipeId) {
        const recipe = this.getRecipeById(recipeId);
        if (!recipe) return;
        
        const modalBody = document.getElementById('quickViewBody');
        if (!modalBody) return;
        
        modalBody.innerHTML = `
            <div class="quick-view">
                <img src="${recipe.image}" alt="${recipe.title}">
                <div class="quick-view-content">
                    <span>${recipe.category}</span>
                    <h2>${recipe.title}</h2>
                    <p>${recipe.description}</p>
                    <a href="recipe.html?id=${recipe.id}" class="btn btn-primary">Tarifi G√∂r√ºnt√ºle</a>
                </div>
            </div>
        `;
        
        Modal.open('quickViewModal');
    },

    // ============================================
    // MALZEME FONKSƒ∞YONLARI (YENƒ∞)
    // ============================================

    // Markdown'dan malzemeleri √ßek (JSON'da yoksa)
    extractIngredientsFromMarkdown(html) {
        const temp = document.createElement('div');
        temp.innerHTML = html;
        
        // "Malzemeler" ba≈ülƒ±ƒüƒ±nƒ± bul (h2, h3, strong olabilir)
        const headings = temp.querySelectorAll('h2, h3, strong');
        let ingredientsList = null;
        
        for (let heading of headings) {
            if (heading.textContent.toLowerCase().includes('malzemeler')) {
                // Ba≈ülƒ±ktan sonraki ilk ul/ol listeyi al
                let nextEl = heading.nextElementSibling;
                while (nextEl) {
                    if (nextEl.tagName === 'UL' || nextEl.tagName === 'OL') {
                        ingredientsList = nextEl;
                        break;
                    }
                    nextEl = nextEl.nextElementSibling;
                }
                break;
            }
        }
        
        if (ingredientsList) {
            return Array.from(ingredientsList.querySelectorAll('li')).map(li => li.textContent.trim());
        }
        return null;
    },

    renderIngredients(recipe, markdownHtml = null) {
        const ingredientsList = document.getElementById('ingredientsList');
        const servingsCount = document.getElementById('servingsCount');

        if (servingsCount) servingsCount.textContent = recipe.servings;

        let ingredients = null;

        // 1. √ñnce JSON'dan dene
        if (recipe.ingredients && Array.isArray(recipe.ingredients) && recipe.ingredients.length > 0) {
            ingredients = recipe.ingredients;
        } 
        // 2. Yoksa Markdown'dan √ßek
        else if (markdownHtml) {
            ingredients = this.extractIngredientsFromMarkdown(markdownHtml);
        }

        if (ingredients && ingredients.length > 0) {
            this.originalIngredients = ingredients;
            
            if (ingredientsList) {
                ingredientsList.innerHTML = ingredients.map(text => `
                    <div class="ingredient-item">
                        <div class="ingredient-checkbox" onclick="this.classList.toggle('checked'); this.nextElementSibling.classList.toggle('checked')"></div>
                        <span class="ingredient-text" data-original="${text}">${text}</span>
                    </div>
                `).join('');
            }
        } else {
            if (ingredientsList) {
                ingredientsList.innerHTML = '<div class="ingredient-item"><span style="color: var(--color-text-secondary);">Malzeme listesi bulunamadƒ±</span></div>';
            }
        }
    },

    updateServingsDisplay() {
        const servingsCount = document.getElementById('servingsCount');
        if (servingsCount) {
            const newServings = Math.round(this.originalServings * this.servingsMultiplier * 10) / 10;
            servingsCount.textContent = newServings + ' ki≈üilik';
        }

        const ingredientItems = document.querySelectorAll('.ingredient-text');
        ingredientItems.forEach((item, index) => {
            const originalText = this.originalIngredients[index];
            if (originalText) {
                item.textContent = this.scaleIngredient(originalText, this.servingsMultiplier);
            }
        });
    },

    scaleIngredient(text, multiplier) {
        // "500 gr et" -> "750 gr et" (1.5x √ßarpanla)
        return text.replace(/(\d+(?:[.,]\d+)?)/g, (match) => {
            const num = parseFloat(match.replace(',', '.'));
            if (isNaN(num)) return match;
            
            const newNum = num * multiplier;
            return Number.isInteger(newNum) ? newNum : newNum.toFixed(1).replace('.', ',');
        });
    },

    bindServingsButtons() {
        document.getElementById('increaseServings')?.addEventListener('click', () => {
            if (this.servingsMultiplier < 3) {
                this.servingsMultiplier += 0.5;
                this.updateServingsDisplay();
            }
        });
        
        document.getElementById('decreaseServings')?.addEventListener('click', () => {
            if (this.servingsMultiplier > 0.5) {
                this.servingsMultiplier -= 0.5;
                this.updateServingsDisplay();
            }
        });
    },

    async loadRecipeDetail() {
        const recipeId = new URLSearchParams(window.location.search).get('id');
        if (!recipeId) return;
        
        if (!this.data) await this.loadRecipes();
        
        const recipe = this.getRecipeById(recipeId);
        if (!recipe) {
            Toast.show('Tarif bulunamadƒ±', 'error');
            return;
        }
        
        this.currentRecipe = recipe;
        this.servingsMultiplier = 1;
        this.originalServings = recipe.servings || 4;
        document.title = `${recipe.title} | Lezzet Yolculuƒüu`;
        
        // Hero bilgileri
        document.getElementById('recipeHeroImage').src = recipe.image;
        document.getElementById('recipeCategory').textContent = recipe.category;
        document.getElementById('recipeTitle').textContent = recipe.title;
        document.getElementById('recipePrepTime').textContent = recipe.prepTime;
        document.getElementById('recipeCookTime').textContent = recipe.cookTime;
        document.getElementById('recipeServings').textContent = recipe.servings + ' ki≈üilik';
        document.getElementById('recipeDifficulty').textContent = recipe.difficulty;
        
        // Markdown i√ßeriƒüini y√ºkle
        const contentHtml = await this.loadRecipeContent(recipe.contentFile);
        document.getElementById('instructionsContent').innerHTML = contentHtml;
        
        // Malzemeleri g√∂ster (√∂nce JSON, yoksa Markdown'dan)
        this.renderIngredients(recipe, contentHtml);
        
        // + ve - butonlarƒ±nƒ± aktifle≈ütir
        this.bindServingsButtons();
    }
};

document.addEventListener('DOMContentLoaded', () => {
    Recipes.init();
});

window.Recipes = Recipes;
